<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Recherche de structures</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background-color: #f7f7f7;
        }

        input, button, select {
            padding: 10px;
            margin: 5px;
        }

        #categories {
            margin-bottom: 20px;
        }

        .cat-btn {
            background: #1976d2;
            color: white;
            border: none;
            border-radius: 5px;
            margin: 3px;
            padding: 8px 16px;
            cursor: pointer;
        }

            .cat-btn:hover {
                background: #1565c0;
            }

        #results > div {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
        }

        .score {
            color: green;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>🔍 Rechercher une structure d'accompagnement</h1>
    <input type="text" id="searchBar" placeholder="Ex : étudiant étranger, addiction, logement..." size="50">
    <button onclick="searchCombined()">🔀 Rechercher (BM25 + W2V)</button>
    <div id="categories"></div>
    <div id="results"></div>
    <script>
        // Remplacez cette URL par l'URL de votre application Heroku
        const API_BASE_URL = 'https://arcane-crag-37038-758c9aa15013.herokuapp.com/';

        // Appuie sur "Entrée" pour lancer la recherche
        document.getElementById("searchBar").addEventListener("keydown", function (event) {
            if (event.key === "Enter") {
                searchCombined();
            }
        });

        // Charger les catégories au démarrage
        window.onload = async function () {
            const catDiv = document.getElementById('categories');
            try {
                const response = await fetch(`${API_BASE_URL}/categories`);
                const categories = await response.json();
                if (!categories.length) {
                    catDiv.innerHTML = "<p>Aucune catégorie trouvée.</p>";
                    return;
                }
                catDiv.innerHTML = categories.map(cat =>
                    `<button class="cat-btn" onclick="showCategory('${cat.replace(/'/g, "\\'")}')">${cat}</button>`
                ).join('');
            } catch (err) {
                catDiv.innerHTML = "<p>Erreur lors du chargement des catégories.</p>";
                console.error(err);
            }
        };

        function linkify(text) {
            if (typeof text !== 'string') return text;
            text = text.replace(/(https?:\/\/[^\s<>"']+)/g, '<a href="$1" target="_blank">$1</a>');
            text = text.replace(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g, '<a href="mailto:$1">$1</a>');
            return text;
        }

        async function searchCombined() {
            const query = document.getElementById('searchBar').value.trim();
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = "<p>Recherche combinée en cours...</p>";
            if (!query) {
                resultsDiv.innerHTML = "<p>Veuillez entrer un mot-clé.</p>";
                return;
            }
            try {
                const response = await fetch(`${API_BASE_URL}/search_combined?query=${encodeURIComponent(query)}`);
                const results = await response.json();
                resultsDiv.innerHTML = '<h2>Résultats combinés :</h2>';
                if (!results.length) {
                    resultsDiv.innerHTML += '<p>Aucun résultat trouvé.</p>';
                    return;
                }
                results.forEach(r => {
                    resultsDiv.innerHTML += `
                            <div>
                                <strong>Dispositif :</strong> ${linkify(r.Dispositif || 'Non spécifié')}<br>
                                <strong>Description :</strong> ${linkify(r.Description || 'Non disponible')}<br>
                                <strong>Contact :</strong> ${linkify(r.Contact || '—')}<br>
                                <strong>Adresse :</strong> ${linkify(r.Adresse || '—')}<br>
                                <strong>Conditions d'accès :</strong> ${linkify(r["Conditions d'accès"] || '—')}<br>
                                <strong>Catégorie :</strong> ${linkify(r.Catégorie || '—')}<br>
                                <span class="score">Pertinence combinée : ${r.similarity}</span>
                            </div>
                        `;
                });
            } catch (err) {
                resultsDiv.innerHTML = "<p>Erreur lors de la recherche combinée.</p>";
                console.error(err);
            }
        }

        async function showCategory(cat) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = "<p>Chargement des fiches...</p>";
            try {
                const response = await fetch(`${API_BASE_URL}/category/${encodeURIComponent(cat)}`);
                const results = await response.json();
                resultsDiv.innerHTML = `<h2>Catégorie : ${cat}</h2>`;
                if (!results.length) {
                    resultsDiv.innerHTML += '<p>Aucune fiche trouvée.</p>';
                    return;
                }
                results.forEach(r => {
                    let ficheHtml = '<div>';
                    for (const [key, value] of Object.entries(r)) {
                        if (key !== 'Catégorie') {
                            ficheHtml += `<strong>${key} :</strong> ${linkify(value || '—')}<br>`;
                        }
                    }
                    ficheHtml += '</div>';
                    resultsDiv.innerHTML += ficheHtml;
                });
            } catch (err) {
                resultsDiv.innerHTML = "<p>Erreur lors du chargement des fiches.</p>";
                console.error(err);
            }
        }
    </script>
</body>
</html>
